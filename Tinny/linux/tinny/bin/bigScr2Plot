#! /usr/bin/perl -w -s

#-----------------------------------------------------

our( $bin, $rate, $recon );
defined $bin   or $bin   = 10;
defined $rate  or $rate  = 0.01;
defined $recon or $recon = 30;

#-----------------------------------------------------

my @update_date = ();
my @frauds = ();
my @non_frauds = ();
my @trx_frauds = ();
my @trx_non_frauds = ();
my @amt_loss_rt = ();

for ( my $i = 0; $i <= 1000; $i += $bin ) {
    $update_date[$i] = 1;
    $trx_non_frauds[$i] = 0;
    $trx_frauds[$i] = 0;
    $frauds[$i] = 0;
    $non_frauds[$i] = 0;
    $amt_loss_rt[$i] = 0;
}

#-----------------------------------------------------

my $pre_acc = "NA======NA";

while (<>) {

    print STDERR "$.\r" if ($. % 1000 == 0);

    chomp;

    # zero indexed
    ($acc_num, $amount, $date, $tag, $score) = unpack("a19 a14 \@34 a8 \@59 a1 \@83 a4",$_);

    # empty account number
    if ( $acc_num =~ /^\s+$/ ) {
	print STDERR "Error: empty accound number at line $.\n";
    }

    # empty trans amount
    if ( $amount =~ /^\s+$/ ) {
	$amount = 0;
    }

    # new account
    if ( $acc_num ne $pre_acc ) {

	for ( my $i = 0; $i <= 1000; $i += $bin ) {
	    $update_date[$i] = 1;
	}

	$pre_acc = $acc_num;

    }

    my $current_date = daysSince90( $date );

    for ( my $i = 0; $i <= 1000; $i += $bin ) {

	if ( $tag eq "0"  and
	     $i <= $score ) {
	    $trx_non_frauds[$i]++;
	}

	if ( $tag eq "1"  and
	     $i <= $score ) {
	    $trx_frauds[$i]++;
	}

	if ( $tag eq "0"  and
             $i <= $score and
	     ($current_date - $update_date[$i] > $recon) ) {

	    $non_frauds[$i]++;
	    $update_date[$i] = $current_date;

	}

	if ( $tag eq "1" and
	     $i <= $score and
	     $update_date[$i] == 1) {

	    $frauds[$i]++;
	    $update_date[$i] = $current_date;

	}

	if ( $tag eq "1" and $update_date[$i] == 1 ) {

	    $amt_loss_rt[$i] += $amount;

	}

    }

}

#--------------------------------------------------------------

open( PLOT, "> performance_plots.dat" ) or die "$!: performance_plots.dat";

printf PLOT "#%10s\t%10s\t%10s\t%10s\t%10s\t%10s\n",
             "Threshold", "AFPR", "ADR", "RT_VDR", "TRX_REVIEW", "TRX_DR";

for ( my $i = 0; $i <= 1000; $i += $bin ) {

    my $trx_review = 100.0 * ($trx_non_frauds[$i] / $rate + $trx_frauds[$i]) / ($trx_non_frauds[0] / $rate + $trx_frauds[0]);
    my $trx_dr     = 100.0 * $trx_frauds[$i] / $trx_frauds[0];

    my $adr = 0;
    if ( $frauds[0] > 0 ) {
	$adr = 100.0 * $frauds[$i] / $frauds[0];
    }

    my $afpr = 0;
    if ( $frauds[$i] > 0 ) {
	$afpr = $non_frauds[$i] / $rate / $frauds[$i];
    }

    my $rt_vdr = 0;
    if ( $amt_loss_rt[1000] > 0 ) {
	$rt_vdr = 100.0 * ( $amt_loss_rt[1000] - $amt_loss_rt[$i] ) / $amt_loss_rt[1000];
    }

    printf PLOT "%11d\t%10d\t%10.6f\t%10.6f\t%10.6f\t%10.6f\n",
	        $i, $afpr, $adr, $rt_vdr, $trx_review, $trx_dr;

}

close(PLOT);

#--------------------------------------------------------------

sub daysSince90 {

    my $date_str = shift;

    ($yy, $mm, $dd) = unpack("a4 a2 a2", $date_str);

    my $num_leaps_since_90 = 0;
    for ( my $i = 1990; $i <= $yy; $i++ ) {
	$num_leaps_since_90++ if ($i%4 == 0);
    }

    my @month_days = qw(31 28 31 30 31 30 31 31 30 31 30 31);

    my $sum = 0;
    for ( my $i = 1; $i < $mm; $i++ ) {
	$sum += $month_days[$i];
    }

    if ( $yy == 2008 and $mm <= 2 ) {
	$sum += 365 * ($yy - 1990) + $num_leaps_since_90 - 1 + $dd;
    }
    else {
	$sum += 365 * ($yy - 1990) + $num_leaps_since_90 + $dd;
    }

    return $sum;

}

#--------------------------------------------------------------
